name: Pull Request Check

on:
  pull_request:
    paths:
      - "**/*.yaml"
      - '!.yam.yaml'
      - '!.github/pipelines/**/*.yaml'

concurrency:
  group: pull-request-check-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: write

jobs:
  changed-files:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.changes.outputs.melange_all_changed_files }}
    steps:
      - uses: actions/checkout@v6

      - name: Look for changed files
        id: changes
        uses: tj-actions/changed-files@v47
        with:
          matrix: true
          files_ignore_yaml: |
            melange:
              - .yam.yaml
              - .github/pipelines/**/*.yaml
          files_yaml: |
            melange:
              - ./**/*.yaml
      
      - name: List all changed files
        run: echo '${{ steps.changes.outputs.melange_all_changed_files }}'

  bump-epoch-priority:
    runs-on: ubuntu-latest
    needs: changed-files
    outputs:
      bumped: ${{ steps.bump.outputs.bumped }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          persist-credentials: false

      - uses: octo-sts/action@v1.1.1
        id: octo-sts
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        with:
          scope: ${{ github.repository }}
          identity: pr-epoch-priority-bump

      - name: Bump epoch priority in changed YAML files
        id: bump
        env:
          CHANGED_FILES_JSON: ${{ needs.changed-files.outputs.matrix }}
          SAME_REPO_PR: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
          OCTO_STS_TOKEN: ${{ steps.octo-sts.outputs.token }}
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          set -euo pipefail

          if [ -z "${CHANGED_FILES_JSON}" ] || [ "${CHANGED_FILES_JSON}" = "[]" ]; then
            echo "bumped=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          updated=false
          processed_files=""

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ ! -f "$file" ] && continue

            if grep -qF 'epoch: 0 # Start epoch at 100 to have higher priority than wolfi/os' "$file"; then
              sed -i 's/epoch: 0 # Start epoch at 100 to have higher priority than wolfi\/os/epoch: 100 # Start epoch at 100 to have higher priority than wolfi\/os/g' "$file"
              updated=true
              processed_files+="$file"$'\n'
            fi
          done < <(jq -r '.[]' <<< "$CHANGED_FILES_JSON")

          if [ "$updated" != true ]; then
            echo "bumped=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "${SAME_REPO_PR}" != "true" ]; then
            echo "bumped=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -z "${OCTO_STS_TOKEN}" ]; then
            echo "Missing octo-sts token for same-repo PR"
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ ! -f "$file" ] && continue
            git add -- "$file"
          done <<< "$processed_files"

          if git diff --cached --quiet; then
            echo "bumped=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git commit -m "chore: bump epoch priority to 100"
          git remote set-url origin "https://x-access-token:${OCTO_STS_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git push origin "HEAD:${PR_HEAD_REF}"

          echo "bumped=true" >> "$GITHUB_OUTPUT"

  lint:
    runs-on: ubuntu-latest
    needs:
      - changed-files
      - bump-epoch-priority
    if: ${{ needs.bump-epoch-priority.outputs.bumped != 'true' }}
    steps:
      - uses: actions/checkout@v6

      - name: Get changed files in space separated string
        id: changes
        run: echo "files=$(jq -r 'join(" ")' <<< '${{ needs.changed-files.outputs.matrix }}')" >> "$GITHUB_OUTPUT"

      - name: Lint using Wolfictl
        uses: wolfi-dev/actions/wolfictl-lint@main
        with:
          args: ${{ steps.changes.outputs.files }}

  build-test:
    if: ${{ !github.event.pull_request.draft && needs.bump-epoch-priority.outputs.bumped != 'true' }}
    runs-on: ubuntu-latest
    needs:
      - changed-files
      - bump-epoch-priority
    strategy:
      matrix:
        package: ${{ fromJson(needs.changed-files.outputs.matrix) }}
      fail-fast: false
    name: Build test ${{ matrix.package }} | x86_64
    steps:
      - uses: actions/checkout@v6

      - uses: glimmer-labs/wolfi/.github/actions/setup-melange@main
      
      - uses: actions/cache@v5
        if: ${{ !env.ACT }}
        with:
          path: apk-cache
          key: x86_64-apk-cache
        
      - run: melange keygen melange.rsa

      - name: Build package
        run: |
          packageName=${{ matrix.package }}
          packageName=${packageName%.yaml}

          melange build \
            -r https://wolfi.glimmerlabs.dev \
            -k https://wolfi.glimmerlabs.dev/glimmer-labs-signing.rsa.pub \
            -r https://packages.wolfi.dev/os \
            -k https://packages.wolfi.dev/os/wolfi-signing.rsa.pub \
            --arch x86_64 \
            --generate-index=false \
            --apk-cache-dir apk-cache \
            --signing-key melange.rsa \
            --git-repo-url=https://github.com/glimmer-labs/wolfi \
            --git-commit=${{ github.sha }} \
            --pipeline-dir=./.github/pipelines \
            --source-dir=./${packageName} \
            ${{ matrix.package }}

      - name: Fix APK cache permissions for upload
        if: always()
        run: sudo chown -R $USER:$USER apk-cache || true